<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MedScan â€” Medical Report Scanner</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --navy:    #0B1F3A;
    --blue:    #1A56DB;
    --cyan:    #06B6D4;
    --green:   #10B981;
    --yellow:  #F59E0B;
    --red:     #EF4444;
    --surface: #F0F4FA;
    --card:    #FFFFFF;
    --text:    #1E293B;
    --muted:   #64748B;
    --border:  #E2E8F0;
    --shadow:  0 4px 24px rgba(11,31,58,.10);
  }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--surface);
    color: var(--text);
    min-height: 100vh;
  }

  /* â”€â”€ Header â”€â”€ */
  header {
    background: var(--navy);
    padding: 0 32px;
    height: 64px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: sticky;
    top: 0;
    z-index: 100;
    box-shadow: 0 2px 20px rgba(0,0,0,.3);
  }
  .logo {
    display: flex;
    align-items: center;
    gap: 10px;
    color: white;
    font-size: 20px;
    font-weight: 700;
    letter-spacing: -.3px;
  }
  .logo-icon {
    width: 36px; height: 36px;
    background: linear-gradient(135deg, var(--cyan), var(--blue));
    border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    font-size: 18px;
  }
  .logo span { color: var(--cyan); }
  .header-btn {
    background: rgba(255,255,255,.1);
    border: 1px solid rgba(255,255,255,.2);
    color: white;
    padding: 8px 18px;
    border-radius: 8px;
    cursor: pointer;
    font-family: inherit;
    font-size: 14px;
    font-weight: 500;
    display: flex; align-items: center; gap: 6px;
    transition: all .2s;
  }
  .header-btn:hover { background: rgba(255,255,255,.2); }

  /* â”€â”€ Tabs â”€â”€ */
  .tabs {
    background: var(--navy);
    padding: 0 32px;
    display: flex;
    gap: 4px;
    border-top: 1px solid rgba(255,255,255,.07);
  }
  .tab {
    padding: 12px 20px;
    color: rgba(255,255,255,.5);
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    border-bottom: 2px solid transparent;
    transition: all .2s;
  }
  .tab:hover { color: rgba(255,255,255,.8); }
  .tab.active { color: var(--cyan); border-bottom-color: var(--cyan); }

  /* â”€â”€ Main â”€â”€ */
  main { max-width: 1200px; margin: 0 auto; padding: 32px; }

  /* â”€â”€ Upload Zone â”€â”€ */
  .page { display: none; }
  .page.active { display: block; }

  .upload-section {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-bottom: 24px;
  }

  .drop-zone {
    border: 2px dashed var(--border);
    border-radius: 16px;
    padding: 40px 24px;
    text-align: center;
    cursor: pointer;
    transition: all .25s;
    background: var(--card);
    position: relative;
  }
  .drop-zone:hover, .drop-zone.dragging {
    border-color: var(--blue);
    background: #EFF6FF;
  }
  .drop-zone input[type=file] {
    position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%;
  }
  .drop-icon {
    font-size: 40px;
    margin-bottom: 12px;
    display: block;
  }
  .drop-zone h3 { font-size: 16px; font-weight: 600; margin-bottom: 6px; }
  .drop-zone p  { font-size: 13px; color: var(--muted); }

  /* â”€â”€ Camera Section â”€â”€ */
  .camera-box {
    background: var(--card);
    border-radius: 16px;
    overflow: hidden;
    border: 2px solid var(--border);
    display: flex;
    flex-direction: column;
  }
  .camera-preview {
    background: #0B1F3A;
    position: relative;
    aspect-ratio: 4/3;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
  }
  #videoEl {
    width: 100%; height: 100%; object-fit: cover;
    display: none;
  }
  #canvasEl { display: none; }
  .camera-placeholder {
    text-align: center;
    color: rgba(255,255,255,.4);
  }
  .camera-placeholder .icon { font-size: 48px; display: block; margin-bottom: 8px; }
  .camera-placeholder p { font-size: 13px; }
  .camera-controls {
    padding: 14px 16px;
    display: flex;
    gap: 10px;
    justify-content: center;
  }

  /* â”€â”€ Buttons â”€â”€ */
  .btn {
    padding: 10px 20px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-family: inherit;
    font-size: 14px;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    gap: 7px;
    transition: all .2s;
  }
  .btn-primary { background: var(--blue);  color: white; }
  .btn-primary:hover { background: #1346BC; transform: translateY(-1px); }
  .btn-success { background: var(--green); color: white; }
  .btn-success:hover { background: #059669; transform: translateY(-1px); }
  .btn-danger  { background: var(--red);   color: white; }
  .btn-danger:hover  { background: #DC2626; }
  .btn-outline {
    background: transparent;
    border: 1.5px solid var(--border);
    color: var(--text);
  }
  .btn-outline:hover { border-color: var(--blue); color: var(--blue); }
  .btn:disabled { opacity: .45; cursor: not-allowed; transform: none !important; }

  .scan-bar {
    display: flex;
    gap: 12px;
    align-items: center;
    margin-bottom: 24px;
    background: var(--card);
    padding: 16px 20px;
    border-radius: 12px;
    border: 1px solid var(--border);
  }
  .scan-bar .file-count {
    font-size: 13px;
    color: var(--muted);
    margin-left: auto;
  }

  /* â”€â”€ Results â”€â”€ */
  .results-grid {
    display: flex;
    flex-direction: column;
    gap: 16px;
    margin-bottom: 24px;
  }

  .result-card {
    background: var(--card);
    border-radius: 14px;
    border: 1px solid var(--border);
    overflow: hidden;
    box-shadow: var(--shadow);
    animation: slideIn .3s ease;
  }
  @keyframes slideIn {
    from { opacity: 0; transform: translateY(12px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  .result-header {
    padding: 14px 20px;
    background: linear-gradient(135deg, var(--navy), #1A3560);
    color: white;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  .result-header h3 { font-size: 15px; font-weight: 600; }
  .result-header .ts { font-size: 12px; color: rgba(255,255,255,.6); font-family: 'DM Mono', monospace; }

  .result-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap: 0;
  }
  .field {
    padding: 14px 16px;
    border-right: 1px solid var(--border);
    border-bottom: 1px solid var(--border);
  }
  .field:nth-child(n) { }
  .field-label {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: .5px;
    color: var(--muted);
    font-weight: 600;
    margin-bottom: 4px;
  }
  .field-value {
    font-size: 15px;
    font-weight: 600;
    color: var(--text);
    font-family: 'DM Mono', monospace;
  }
  .field-value.empty { color: var(--muted); font-size: 13px; font-weight: 400; font-family: inherit; }

  /* Status badges */
  .badge {
    display: inline-block;
    padding: 3px 10px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    font-family: inherit;
  }
  .badge-high     { background: #FEE2E2; color: #991B1B; }
  .badge-elevated { background: #FEF3C7; color: #92400E; }
  .badge-normal   { background: #D1FAE5; color: #065F46; }
  .badge-low      { background: #DBEAFE; color: #1E40AF; }
  .badge-diabetic { background: #FEE2E2; color: #991B1B; }
  .badge-prediab  { background: #FEF3C7; color: #92400E; }

  /* â”€â”€ Save bar â”€â”€ */
  .save-bar {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 16px 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 16px;
    margin-bottom: 24px;
  }
  .save-bar p { font-size: 14px; color: var(--muted); }
  .save-bar strong { color: var(--text); }

  /* â”€â”€ Progress â”€â”€ */
  .progress-bar-wrap {
    background: #E2E8F0;
    border-radius: 4px;
    height: 6px;
    overflow: hidden;
    margin: 8px 0;
  }
  .progress-bar {
    height: 6px;
    background: linear-gradient(90deg, var(--blue), var(--cyan));
    border-radius: 4px;
    transition: width .4s ease;
    width: 0%;
  }

  /* â”€â”€ Records table â”€â”€ */
  .table-wrap {
    background: var(--card);
    border-radius: 14px;
    border: 1px solid var(--border);
    overflow-x: auto;
    box-shadow: var(--shadow);
  }
  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 13px;
    white-space: nowrap;
  }
  thead th {
    background: var(--navy);
    color: white;
    padding: 13px 16px;
    text-align: left;
    font-weight: 600;
    font-size: 12px;
    letter-spacing: .3px;
  }
  tbody tr:nth-child(even)  { background: var(--surface); }
  tbody tr:hover { background: #EFF6FF; }
  tbody td {
    padding: 11px 16px;
    border-bottom: 1px solid var(--border);
    color: var(--text);
  }
  tbody td.mono { font-family: 'DM Mono', monospace; font-size: 12px; }

  /* â”€â”€ Loader â”€â”€ */
  .loader-overlay {
    display: none;
    position: fixed; inset: 0;
    background: rgba(11,31,58,.6);
    z-index: 999;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    gap: 16px;
  }
  .loader-overlay.show { display: flex; }
  .spinner {
    width: 48px; height: 48px;
    border: 4px solid rgba(255,255,255,.2);
    border-top-color: var(--cyan);
    border-radius: 50%;
    animation: spin .8s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .loader-text { color: white; font-size: 15px; font-weight: 500; }

  /* â”€â”€ Toast â”€â”€ */
  .toast {
    position: fixed; bottom: 24px; right: 24px;
    padding: 12px 20px;
    border-radius: 10px;
    font-size: 14px;
    font-weight: 500;
    color: white;
    z-index: 9999;
    transform: translateY(80px);
    transition: transform .3s ease;
    display: flex; align-items: center; gap: 8px;
  }
  .toast.show { transform: translateY(0); }
  .toast.success { background: var(--green); }
  .toast.error   { background: var(--red); }
  .toast.info    { background: var(--blue); }

  /* â”€â”€ Empty state â”€â”€ */
  .empty-state {
    text-align: center;
    padding: 64px 32px;
    color: var(--muted);
  }
  .empty-state .icon { font-size: 56px; display: block; margin-bottom: 16px; }
  .empty-state h3 { font-size: 18px; font-weight: 600; color: var(--text); margin-bottom: 6px; }

  /* Stats cards */
  .stats-row {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 16px;
    margin-bottom: 24px;
  }
  .stat-card {
    background: var(--card);
    border-radius: 12px;
    padding: 20px;
    border: 1px solid var(--border);
    box-shadow: var(--shadow);
  }
  .stat-card .label { font-size: 12px; color: var(--muted); text-transform: uppercase; letter-spacing: .5px; font-weight: 600; }
  .stat-card .value { font-size: 28px; font-weight: 700; color: var(--navy); margin-top: 4px; font-family: 'DM Mono', monospace; }
  .stat-card .sub   { font-size: 12px; color: var(--muted); margin-top: 2px; }

  @media (max-width: 768px) {
    main { padding: 16px; }
    .upload-section { grid-template-columns: 1fr; }
    .stats-row { grid-template-columns: 1fr 1fr; }
    .tabs { padding: 0 16px; }
    header { padding: 0 16px; }
  }
</style>
</head>
<body>

<!-- Loader -->
<div class="loader-overlay" id="loader">
  <div class="spinner"></div>
  <p class="loader-text" id="loaderText">Processing imagesâ€¦</p>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- Header -->
<header>
  <div class="logo">
    <div class="logo-icon">ğŸ©º</div>
    Med<span>Scan</span>
  </div>
  <button class="header-btn" onclick="openSheet()">
    ğŸ“Š Open Google Sheet
  </button>
</header>

<!-- Tabs -->
<div class="tabs">
  <div class="tab active" onclick="switchTab('scan', this)">ğŸ“· Scan Reports</div>
  <div class="tab" onclick="switchTab('records', this)">ğŸ“‹ All Records</div>
</div>

<main>

  <!-- â•â•â•â• SCAN TAB â•â•â•â• -->
  <div class="page active" id="page-scan">

    <div class="upload-section">

      <!-- File upload -->
      <div class="drop-zone" id="dropZone">
        <input type="file" id="fileInput" accept="image/*" multiple>
        <span class="drop-icon">ğŸ“</span>
        <h3>Upload Report Images</h3>
        <p>Drag & drop or click to select<br>PNG, JPG, JPEG â€” multiple files supported</p>
      </div>

      <!-- Camera -->
      <div class="camera-box">
        <div class="camera-preview">
          <video id="videoEl" autoplay playsinline></video>
          <canvas id="canvasEl"></canvas>
          <div class="camera-placeholder" id="camPlaceholder">
            <span class="icon">ğŸ“·</span>
            <p>Camera not active</p>
          </div>
          <img id="capturedImg" style="display:none;width:100%;height:100%;object-fit:cover;">
        </div>
        <div class="camera-controls">
          <button class="btn btn-outline" onclick="startCamera()" id="btnStartCam">â–¶ Start Camera</button>
          <button class="btn btn-primary" onclick="capturePhoto()" id="btnCapture" disabled>ğŸ“¸ Capture</button>
          <button class="btn btn-outline" onclick="stopCamera()" id="btnStopCam" style="display:none;">â–  Stop</button>
        </div>
      </div>
    </div>

    <!-- Scan bar -->
    <div class="scan-bar">
      <button class="btn btn-primary" onclick="scanAll()" id="btnScan" disabled>
        ğŸ” Scan Images
      </button>
      <button class="btn btn-outline" onclick="clearAll()">âœ• Clear</button>
      <span class="file-count" id="fileCount">No images selected</span>
    </div>

    <!-- Progress -->
    <div id="progressWrap" style="display:none;margin-bottom:16px;">
      <div style="font-size:13px;color:var(--muted);margin-bottom:4px;" id="progressLabel">Scanningâ€¦</div>
      <div class="progress-bar-wrap"><div class="progress-bar" id="progressBar"></div></div>
    </div>

    <!-- Results -->
    <div id="resultsContainer"></div>

    <!-- Save bar -->
    <div class="save-bar" id="saveBar" style="display:none;">
      <p>âœ… <strong id="scanCount">0</strong> records scanned and ready to save</p>
      <div style="display:flex;gap:10px;">
        <button class="btn btn-outline" onclick="editMode()">âœï¸ Edit</button>
        <button class="btn btn-success" onclick="saveAll()">â˜ï¸ Save to Google Sheets</button>
      </div>
    </div>

  </div>

  <!-- â•â•â•â• RECORDS TAB â•â•â•â• -->
  <div class="page" id="page-records">

    <div class="stats-row" id="statsRow">
      <div class="stat-card">
        <div class="label">Total Patients</div>
        <div class="value" id="statTotal">â€”</div>
        <div class="sub">All records</div>
      </div>
      <div class="stat-card">
        <div class="label">High BP</div>
        <div class="value" id="statHighBP" style="color:var(--red)">â€”</div>
        <div class="sub">Systolic â‰¥140</div>
      </div>
      <div class="stat-card">
        <div class="label">Diabetic</div>
        <div class="value" id="statDiab" style="color:var(--red)">â€”</div>
        <div class="sub">Fasting â‰¥126</div>
      </div>
      <div class="stat-card">
        <div class="label">Avg BMI</div>
        <div class="value" id="statBMI" style="color:var(--blue)">â€”</div>
        <div class="sub">All patients</div>
      </div>
    </div>

    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
      <h2 style="font-size:18px;font-weight:700;">Patient Records</h2>
      <div style="display:flex;gap:10px;">
        <input type="text" id="searchInput" placeholder="ğŸ” Search patientâ€¦"
          oninput="filterTable()"
          style="padding:8px 14px;border-radius:8px;border:1.5px solid var(--border);
                 font-family:inherit;font-size:14px;width:220px;outline:none;">
        <button class="btn btn-outline" onclick="loadRecords()">â†» Refresh</button>
        <button class="btn btn-primary" onclick="openSheet()">ğŸ“Š Open Sheet</button>
      </div>
    </div>

    <div class="table-wrap">
      <table id="recordsTable">
        <thead>
          <tr>
            <th>#</th>
            <th>Timestamp</th>
            <th>Patient Name</th>
            <th>Age</th>
            <th>Gender</th>
            <th>Ht(cm)</th>
            <th>Wt(kg)</th>
            <th>BMI</th>
            <th>Systolic</th>
            <th>Diastolic</th>
            <th>BP Status</th>
            <th>Fasting(mg/dL)</th>
            <th>PP(mg/dL)</th>
            <th>Sugar Status</th>
          </tr>
        </thead>
        <tbody id="recordsBody">
          <tr><td colspan="14">
            <div class="empty-state">
              <span class="icon">ğŸ“‹</span>
              <h3>No records yet</h3>
              <p>Scan some reports to get started</p>
            </div>
          </td></tr>
        </tbody>
      </table>
    </div>

  </div>
</main>

<script>
// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let pendingFiles   = [];   // File objects
let scannedResults = [];   // Extracted data from OCR
let cameraStream   = null;
let allRecords     = [];

// â”€â”€ Tab switching â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(name, el) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('page-' + name).classList.add('active');
  if (name === 'records') loadRecords();
}

// â”€â”€ File upload â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const dropZone  = document.getElementById('dropZone');
const fileInput = document.getElementById('fileInput');

fileInput.addEventListener('change', e => addFiles([...e.target.files]));

dropZone.addEventListener('dragover',  e => { e.preventDefault(); dropZone.classList.add('dragging'); });
dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragging'));
dropZone.addEventListener('drop', e => {
  e.preventDefault();
  dropZone.classList.remove('dragging');
  addFiles([...e.dataTransfer.files].filter(f => f.type.startsWith('image/')));
});

function addFiles(files) {
  pendingFiles = [...pendingFiles, ...files];
  updateFileCount();
}

function updateFileCount() {
  const n = pendingFiles.length;
  document.getElementById('fileCount').textContent =
    n === 0 ? 'No images selected' : `${n} image${n > 1 ? 's' : ''} ready`;
  document.getElementById('btnScan').disabled = n === 0;
}

// â”€â”€ Camera â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function startCamera() {
  try {
    cameraStream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: 'environment', width: { ideal: 1280 } }
    });
    const video = document.getElementById('videoEl');
    video.srcObject = cameraStream;
    video.style.display = 'block';
    document.getElementById('camPlaceholder').style.display = 'none';
    document.getElementById('capturedImg').style.display = 'none';
    document.getElementById('btnCapture').disabled  = false;
    document.getElementById('btnStartCam').style.display = 'none';
    document.getElementById('btnStopCam').style.display  = 'inline-flex';
  } catch(e) {
    showToast('Camera access denied: ' + e.message, 'error');
  }
}

function stopCamera() {
  if (cameraStream) {
    cameraStream.getTracks().forEach(t => t.stop());
    cameraStream = null;
  }
  const video = document.getElementById('videoEl');
  video.style.display = 'none';
  document.getElementById('camPlaceholder').style.display = 'block';
  document.getElementById('btnCapture').disabled  = true;
  document.getElementById('btnStartCam').style.display = 'inline-flex';
  document.getElementById('btnStopCam').style.display  = 'none';
}

function capturePhoto() {
  const video  = document.getElementById('videoEl');
  const canvas = document.getElementById('canvasEl');
  canvas.width  = video.videoWidth;
  canvas.height = video.videoHeight;
  canvas.getContext('2d').drawImage(video, 0, 0);

  canvas.toBlob(blob => {
    const fname = `camera_${Date.now()}.png`;
    const file  = new File([blob], fname, { type: 'image/png' });
    addFiles([file]);

    // Show preview
    const img = document.getElementById('capturedImg');
    img.src = URL.createObjectURL(blob);
    img.style.display = 'block';
    video.style.display = 'none';
    showToast('ğŸ“¸ Photo captured!', 'success');
  }, 'image/png');
}

// â”€â”€ Scan â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function scanAll() {
  if (pendingFiles.length === 0) return;

  scannedResults = [];
  document.getElementById('resultsContainer').innerHTML = '';
  document.getElementById('saveBar').style.display = 'none';

  const progressWrap = document.getElementById('progressWrap');
  const progressBar  = document.getElementById('progressBar');
  const progressLbl  = document.getElementById('progressLabel');
  progressWrap.style.display = 'block';

  setLoader(true, `Scanning ${pendingFiles.length} image(s)â€¦`);

  for (let i = 0; i < pendingFiles.length; i++) {
    const file = pendingFiles[i];
    const pct  = Math.round(((i) / pendingFiles.length) * 100);
    progressBar.style.width = pct + '%';
    progressLbl.textContent = `Scanning ${i+1} of ${pendingFiles.length}: ${file.name}`;

    const formData = new FormData();
    formData.append('images', file);

    try {
      const res  = await fetch('/scan', { method: 'POST', body: formData });
      const json = await res.json();
      if (json.results && json.results.length > 0) {
        const r = json.results[0];
        if (r.success) {
          scannedResults.push(r.data);
          renderResultCard(r.data, i);
        } else {
          const errMsg = r.error || 'Unknown error';
          showToast(`âŒ ${r.filename}: ${errMsg}`, 'error');
          document.getElementById('resultsContainer').innerHTML += `<div style="background:#FEE2E2;border:1px solid #FCA5A5;border-radius:12px;padding:16px 20px;color:#991B1B;font-size:14px;margin-bottom:12px;"><strong>âŒ Failed: ${r.filename}</strong><br><code style="font-size:12px;">${errMsg}</code><br><br><strong>Common fixes:</strong><br>â€¢ Tesseract not installed or wrong path in app.py line 22<br>â€¢ Try: py -m pip install pytesseract pillow</div>`;
        }
      }
    } catch(e) {
      showToast('Scan error: ' + e.message, 'error');
    }
  }

  progressBar.style.width = '100%';
  progressLbl.textContent = `Done â€” ${scannedResults.length} record(s) extracted`;
  setLoader(false);

  if (scannedResults.length > 0) {
    document.getElementById('saveBar').style.display = 'flex';
    document.getElementById('scanCount').textContent = scannedResults.length;
    showToast(`âœ… ${scannedResults.length} record(s) scanned!`, 'success');
  }
}

function renderResultCard(data, idx) {
  const container = document.getElementById('resultsContainer');
  const card = document.createElement('div');
  card.className = 'result-card';
  card.id = 'card-' + idx;

  const bpBadge = bpBadgeHtml(data['BP Status']);
  const sgBadge = sugarBadgeHtml(data['Sugar Status']);

  const fields = [
    { label: 'Patient Name',         value: data['Patient Name'],                  wide: true },
    { label: 'Age',                  value: data['Age'] },
    { label: 'Gender',               value: data['Gender'] },
    { label: 'Height (cm)',          value: data['Height (cm)'] },
    { label: 'Weight (kg)',          value: data['Weight (kg)'] },
    { label: 'BMI',                  value: data['BMI'] },
    { label: 'Systolic BP',          value: data['Systolic BP'] },
    { label: 'Diastolic BP',         value: data['Diastolic BP'] },
    { label: 'BP Status',            value: bpBadge,   isHtml: true },
    { label: 'Fasting Sugar',        value: data['Fasting Sugar (mg/dL)'] },
    { label: 'Post Prandial Sugar',  value: data['Post Prandial Sugar (mg/dL)'] },
    { label: 'Sugar Status',         value: sgBadge,   isHtml: true, wide: true },
  ];

  const fieldsHtml = fields.map(f => {
    const val = f.value || 'â€”';
    const valHtml = f.isHtml ? val :
      `<span class="field-value ${!f.value ? 'empty' : ''}">${val}</span>`;
    return `<div class="field ${f.wide ? 'wide' : ''}">
      <div class="field-label">${f.label}</div>
      ${valHtml}
    </div>`;
  }).join('');

  card.innerHTML = `
    <div class="result-header">
      <h3>ğŸ¥ ${data['Patient Name'] || 'Unknown Patient'}</h3>
      <span class="ts">${data['Timestamp'] || ''}</span>
    </div>
    <div class="result-grid">${fieldsHtml}</div>
  `;
  container.appendChild(card);
}

function bpBadgeHtml(status) {
  const map = { 'High': 'badge-high', 'Elevated': 'badge-elevated',
                'Normal': 'badge-normal', 'Low': 'badge-low' };
  const cls = map[status] || '';
  return status ? `<span class="badge ${cls}">${status}</span>` : '<span class="field-value empty">â€”</span>';
}

function sugarBadgeHtml(status) {
  if (!status) return '<span class="field-value empty">â€”</span>';
  return status.split(' | ').map(s => {
    const cls = s.includes('Diabetic') && !s.includes('Pre') ? 'badge-diabetic' :
                s.includes('Pre') ? 'badge-prediab' : 'badge-normal';
    return `<span class="badge ${cls}" style="margin:2px">${s}</span>`;
  }).join('');
}

// â”€â”€ Save â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function saveAll() {
  if (scannedResults.length === 0) return;
  setLoader(true, 'Saving to Google Sheetsâ€¦');
  try {
    const res  = await fetch('/save', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ rows: scannedResults })
    });
    const json = await res.json();
    setLoader(false);
    if (json.error) {
      showToast('âŒ ' + json.error, 'error');
      return;
    }
    showToast(`âœ… Saved ${json.saved} record(s). Total in Sheet: ${json.total}`, 'success');
    document.getElementById('saveBar').style.display = 'none';
    document.getElementById('resultsContainer').innerHTML +=
      `<div style="background:#D1FAE5;border:1px solid #6EE7B7;border-radius:12px;
                   padding:16px 20px;color:#065F46;font-size:14px;margin-top:12px;">
        âœ… <strong>${json.saved} record(s) saved</strong> to
        <a href="${json.sheet_url}" target="_blank"
           style="color:#065F46;font-weight:700;text-decoration:underline;">
          ğŸ“Š Google Sheet
        </a> â€” Total rows: <strong>${json.total}</strong>.
      </div>`;
    scannedResults = [];
    if (typeof loadRecords === 'function') loadRecords();
  } catch(e) {
    setLoader(false);
    showToast('Save failed: ' + e.message, 'error');
  }
}

async function openSheet() {
  const res  = await fetch('/sheet_url');
  const json = await res.json();
  window.open(json.url, '_blank');
}

function clearAll() {
  pendingFiles = [];
  scannedResults = [];
  document.getElementById('resultsContainer').innerHTML = '';
  document.getElementById('saveBar').style.display = 'none';
  document.getElementById('progressWrap').style.display = 'none';
  document.getElementById('fileInput').value = '';
  updateFileCount();
}

// â”€â”€ Records tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadRecords() {
  try {
    const res  = await fetch('/records');
    allRecords = await res.json();
    renderTable(allRecords);
    updateStats(allRecords);
  } catch(e) {
    showToast('Could not load records', 'error');
  }
}

function renderTable(records) {
  const tbody = document.getElementById('recordsBody');
  if (!records.length) {
    tbody.innerHTML = `<tr><td colspan="14">
      <div class="empty-state">
        <span class="icon">ğŸ“‹</span>
        <h3>No records yet</h3>
        <p>Scan some reports to get started</p>
      </div></td></tr>`;
    return;
  }
  tbody.innerHTML = records.map((r, i) => `
    <tr>
      <td>${i + 1}</td>
      <td class="mono">${r['Timestamp'] || ''}</td>
      <td><strong>${r['Patient Name'] || 'â€”'}</strong></td>
      <td class="mono">${r['Age'] || 'â€”'}</td>
      <td>${r['Gender'] || 'â€”'}</td>
      <td class="mono">${r['Height (cm)'] || 'â€”'}</td>
      <td class="mono">${r['Weight (kg)'] || 'â€”'}</td>
      <td class="mono">${r['BMI'] || 'â€”'}</td>
      <td class="mono">${r['Systolic BP'] || 'â€”'}</td>
      <td class="mono">${r['Diastolic BP'] || 'â€”'}</td>
      <td>${bpBadgeHtml(r['BP Status'])}</td>
      <td class="mono">${r['Fasting Sugar (mg/dL)'] || 'â€”'}</td>
      <td class="mono">${r['Post Prandial Sugar (mg/dL)'] || 'â€”'}</td>
      <td>${sugarBadgeHtml(r['Sugar Status'])}</td>
    </tr>`).join('');
}

function filterTable() {
  const q = document.getElementById('searchInput').value.toLowerCase();
  const filtered = allRecords.filter(r =>
    (r['Patient Name'] || '').toLowerCase().includes(q));
  renderTable(filtered);
}

function updateStats(records) {
  document.getElementById('statTotal').textContent = records.length;
  const highBP = records.filter(r => (r['BP Status'] || '').includes('High')).length;
  document.getElementById('statHighBP').textContent = highBP;
  const diab = records.filter(r => (r['Sugar Status'] || '').includes('Diabetic')).length;
  document.getElementById('statDiab').textContent = diab;
  const bmis = records.map(r => parseFloat(r['BMI'])).filter(b => !isNaN(b));
  const avgBMI = bmis.length ? (bmis.reduce((a,b) => a+b, 0) / bmis.length).toFixed(1) : 'â€”';
  document.getElementById('statBMI').textContent = avgBMI;
}

// â”€â”€ Download â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// downloadExcel removed â€” data lives in Google Sheets now

function editMode() {
  showToast('Click any field in a result card to edit it', 'info');
}

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setLoader(show, text = '') {
  document.getElementById('loader').classList.toggle('show', show);
  if (text) document.getElementById('loaderText').textContent = text;
}

function showToast(msg, type = 'info') {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = `toast ${type} show`;
  setTimeout(() => t.classList.remove('show'), 3500);
}

function renderHandwrittenCard(rows, filename, idx) {
  const container = document.getElementById('resultsContainer');
  const card = document.createElement('div');
  card.className = 'result-card';

  const tableRows = rows.map((r, i) => {
    const bpClass = r['BP Status'] === 'High' ? 'color:#C00000;font-weight:700' :
                    r['BP Status'] === 'Elevated' ? 'color:#7F6000;font-weight:700' :
                    r['BP Status'] === 'Normal' ? 'color:#375623;font-weight:700' : '';
    const prVal = r['Pulse / PR (bpm)'] || 'â€”';
    const prStyle = parseInt(prVal) >= 100 ? 'color:#C00000;font-weight:700' :
                    parseInt(prVal) < 60  ? 'color:#1E40AF;font-weight:700' : '';
    const notes = r['Notes'] ? `<span style="color:#7F6000;font-size:11px;">${r['Notes']}</span>` : '';
    return `<tr>
      <td style="padding:8px 12px;border-bottom:1px solid #E2E8F0;">${i+1}</td>
      <td style="padding:8px 12px;border-bottom:1px solid #E2E8F0;font-weight:600;">${r['Patient Name']}</td>
      <td style="padding:8px 12px;border-bottom:1px solid #E2E8F0;font-family:monospace;">${r['Systolic BP']}/${r['Diastolic BP']}</td>
      <td style="padding:8px 12px;border-bottom:1px solid #E2E8F0;${bpClass}">${r['BP Status']}</td>
      <td style="padding:8px 12px;border-bottom:1px solid #E2E8F0;font-family:monospace;${prStyle}">${prVal}</td>
      <td style="padding:8px 12px;border-bottom:1px solid #E2E8F0;">${notes}</td>
    </tr>`;
  }).join('');

  card.innerHTML = `
    <div class="result-header">
      <h3>ğŸ“‹ Handwritten Table â€” ${rows.length} patients</h3>
      <span class="ts">${rows[0]?.Timestamp || ''}</span>
    </div>
    <div style="overflow-x:auto;">
      <table style="width:100%;border-collapse:collapse;font-size:13px;">
        <thead>
          <tr style="background:#F0F4FA;">
            <th style="padding:10px 12px;text-align:left;font-size:11px;text-transform:uppercase;color:#64748B;">#</th>
            <th style="padding:10px 12px;text-align:left;font-size:11px;text-transform:uppercase;color:#64748B;">Patient Name</th>
            <th style="padding:10px 12px;text-align:left;font-size:11px;text-transform:uppercase;color:#64748B;">BP (mmHg)</th>
            <th style="padding:10px 12px;text-align:left;font-size:11px;text-transform:uppercase;color:#64748B;">BP Status</th>
            <th style="padding:10px 12px;text-align:left;font-size:11px;text-transform:uppercase;color:#64748B;">PR (bpm)</th>
            <th style="padding:10px 12px;text-align:left;font-size:11px;text-transform:uppercase;color:#64748B;">Notes</th>
          </tr>
        </thead>
        <tbody>${tableRows}</tbody>
      </table>
    </div>
    <div style="padding:10px 16px;background:#F8FAFC;font-size:12px;color:#64748B;border-top:1px solid #E2E8F0;">
      âš  Handwritten OCR â€” please verify names above before saving
    </div>
  `;
  container.appendChild(card);
}
</script>
</body>
</html>
